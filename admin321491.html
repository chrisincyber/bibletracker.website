<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - YourBibleTracker</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .admin-header h1 {
            color: var(--text-dark);
        }
        .logout-btn {
            background: var(--border);
            color: var(--text-dark);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .login-container {
            max-width: 400px;
            margin: 4rem auto;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
        }
        .login-container h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-card .label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        .admin-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .admin-idea-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .admin-idea-card.pending {
            border-left: 4px solid #F59E0B;
        }
        .admin-idea-card.approved {
            border-left: 4px solid #10B981;
        }
        .admin-idea-card.rejected {
            border-left: 4px solid #EF4444;
        }
        .idea-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .idea-title {
            font-size: 1.2rem;
            color: var(--text-dark);
            margin: 0;
        }
        .idea-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }
        .idea-meta span {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .idea-description {
            color: var(--text-light);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .idea-contact {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-white);
            border-radius: 0.5rem;
        }
        .idea-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .action-btn.approve {
            background: #10B981;
            color: white;
        }
        .action-btn.reject {
            background: #EF4444;
            color: white;
        }
        .action-btn.delete {
            background: var(--border);
            color: var(--text-dark);
        }
        .status-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.85rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.pending { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .status-badge.approved { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .status-badge.in-progress { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .status-badge.done { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .votes-badge {
            background: var(--bg-white);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            color: var(--text-dark);
        }
        .action-btn.edit {
            background: #3B82F6;
            color: white;
        }
        .hidden { display: none !important; }

        /* Push Notifications Section */
        .push-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .push-section h2 {
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .push-section h2::before {
            content: "ðŸ””";
        }
        .push-form {
            display: grid;
            gap: 1rem;
        }
        .push-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 600px) {
            .push-form .form-row {
                grid-template-columns: 1fr;
            }
        }
        .push-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .push-form label {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .push-form input,
        .push-form textarea {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 1rem;
        }
        .push-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        .push-form .char-count {
            font-size: 0.8rem;
            color: var(--text-light);
            text-align: right;
        }
        .push-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .push-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        .push-stat .number {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
        }
        .send-push-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        .send-push-btn:hover {
            opacity: 0.9;
        }
        .send-push-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .push-history {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }
        .push-history h3 {
            color: var(--text-dark);
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .push-history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .push-history-item {
            background: var(--bg-white);
            border-radius: 0.5rem;
            padding: 0.75rem;
            border-left: 3px solid var(--primary);
        }
        .push-history-item .title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }
        .push-history-item .body {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .push-history-item .meta {
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 1rem;
        }
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        .tab-btn:hover:not(.active) {
            background: var(--border);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Edit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
        }
        .modal h3 {
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }
        .modal .form-group {
            margin-bottom: 1rem;
        }
        .modal .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 600;
        }
        .modal .form-group input,
        .modal .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 1rem;
        }
        .modal .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .modal-actions button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .modal-actions .cancel-btn {
            background: var(--border);
            color: var(--text-dark);
        }
        .modal-actions .save-btn {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2>Admin Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="submit-btn">Login</button>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <nav>
            <div class="container nav-container">
                <a href="index.html" class="logo">
                    <img src="logo.png" alt="YourBibleTracker Logo" class="logo-image">
                    <span class="logo-text">Admin Panel</span>
                </a>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="admin-container">
            <div class="admin-header">
                <h1>Admin Dashboard</h1>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="notifications">Push Notifications</button>
                <button class="tab-btn" data-tab="ideas">Feature Requests</button>
            </div>

            <!-- Push Notifications Tab -->
            <div id="notificationsTab" class="tab-content active">
                <div class="push-section">
                    <h2>Send Push Notification</h2>

                    <div class="push-stats">
                        <div class="push-stat">
                            <span>Subscribers:</span>
                            <span class="number" id="subscriberCount">0</span>
                        </div>
                        <div class="push-stat">
                            <span>Total Sent:</span>
                            <span class="number" id="totalSentCount">0</span>
                        </div>
                    </div>

                    <form id="pushForm" class="push-form">
                        <div class="form-group">
                            <label for="pushTitle">Notification Title *</label>
                            <input type="text" id="pushTitle" placeholder="e.g., New Feature Available!" maxlength="50" required>
                            <span class="char-count"><span id="titleCount">0</span>/50</span>
                        </div>

                        <div class="form-group">
                            <label for="pushBody">Message Body *</label>
                            <textarea id="pushBody" placeholder="Write your notification message here..." maxlength="200" required></textarea>
                            <span class="char-count"><span id="bodyCount">0</span>/200</span>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="pushUrl">Link URL (optional)</label>
                                <input type="url" id="pushUrl" placeholder="https://yourbibletracker.com">
                            </div>
                            <div class="form-group">
                                <label for="pushIcon">Icon (optional)</label>
                                <input type="text" id="pushIcon" placeholder="/logo.png" value="/logo.png">
                            </div>
                        </div>

                        <button type="submit" class="send-push-btn" id="sendPushBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                            Send Notification
                        </button>
                    </form>

                    <div class="push-history">
                        <h3>Recent Notifications</h3>
                        <div id="pushHistoryList" class="push-history-list">
                            <p style="color: var(--text-light); text-align: center;">No notifications sent yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Requests Tab -->
            <div id="ideasTab" class="tab-content">
                <div class="stats-row">
                <div class="stat-card">
                    <div class="number" id="totalCount">0</div>
                    <div class="label">Total Ideas</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="pendingCount">0</div>
                    <div class="label">Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="approvedCount">0</div>
                    <div class="label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalVotes">0</div>
                    <div class="label">Total Votes</div>
                </div>
            </div>

            <div class="admin-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="pending">Pending</button>
                <button class="filter-btn" data-filter="approved">Approved</button>
                <button class="filter-btn" data-filter="rejected">Rejected</button>
            </div>

            <div id="adminIdeasList"></div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Edit Feature Request</h3>
            <input type="hidden" id="editIdeaId">
            <div class="form-group">
                <label for="editTitle">Title</label>
                <input type="text" id="editTitle" required>
            </div>
            <div class="form-group">
                <label for="editDescription">Description</label>
                <textarea id="editDescription" required></textarea>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Password stored as SHA-256 hash - not in plain text
        const PASSWORD_HASH = 'dbbfa81c303bfadf80fd5b9c2bbaf4d500cf6fe49bfdbd1c611f16abc3f65ec7';

        let allIdeas = [];
        let currentFilter = 'all';
        let pushTokens = [];
        let pushHistory = [];

        // SHA-256 hash function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if already logged in
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showAdminPanel();
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const hash = await sha256(password);
            if (hash === PASSWORD_HASH) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                alert('Incorrect password');
            }
        });

        function showAdminPanel() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            initFirebase();
            loadIdeas();
            initFilters();
            initTabs();
            initPushNotifications();
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        function loadIdeas() {
            if (!isFirebaseReady()) {
                setTimeout(loadIdeas, 100);
                return;
            }

            getDatabase().ref('ideas').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    allIdeas = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    allIdeas.sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    allIdeas = [];
                }
                updateStats();
                renderIdeas();
            });
        }

        function updateStats() {
            const pending = allIdeas.filter(i => !i.approved && i.status !== 'rejected').length;
            const approved = allIdeas.filter(i => i.approved).length;
            const totalVotes = allIdeas.reduce((sum, i) => sum + (i.votes || 0), 0);

            document.getElementById('totalCount').textContent = allIdeas.length;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('totalVotes').textContent = totalVotes;
        }

        function filterIdeas() {
            if (currentFilter === 'all') return allIdeas;
            if (currentFilter === 'pending') return allIdeas.filter(i => !i.approved && i.status !== 'rejected');
            if (currentFilter === 'approved') return allIdeas.filter(i => i.approved);
            if (currentFilter === 'rejected') return allIdeas.filter(i => i.status === 'rejected');
            return allIdeas;
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function getStatusClass(idea) {
            if (idea.status === 'rejected') return 'rejected';
            if (idea.approved) return 'approved';
            return 'pending';
        }

        function renderIdeas() {
            const container = document.getElementById('adminIdeasList');
            const filtered = filterIdeas();

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No ideas found.</p>';
                return;
            }

            container.innerHTML = filtered.map(idea => `
                <div class="admin-idea-card ${getStatusClass(idea)}">
                    <div class="idea-header">
                        <h3 class="idea-title">${escapeHtml(idea.title)}</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="votes-badge">${idea.votes || 0} votes</span>
                            <span class="status-badge ${idea.status || 'pending'}">${idea.status || 'pending'}</span>
                        </div>
                    </div>
                    <div class="idea-meta">
                        <span><strong>Category:</strong> ${idea.category}</span>
                        <span><strong>Priority:</strong> ${idea.priority}</span>
                        <span><strong>Submitted:</strong> ${formatDate(idea.timestamp)}</span>
                    </div>
                    <p class="idea-description">${escapeHtml(idea.description)}</p>
                    <div class="idea-contact">
                        <strong>From:</strong> ${escapeHtml(idea.name)}
                        ${idea.email ? `| <strong>Email:</strong> ${escapeHtml(idea.email)}` : ''}
                    </div>
                    <div class="idea-actions">
                        <button class="action-btn edit" onclick="openEditModal('${idea.id}')">Edit</button>
                        ${!idea.approved ? `<button class="action-btn approve" onclick="approveIdea('${idea.id}')">Approve</button>` : ''}
                        ${idea.approved ? `<button class="action-btn reject" onclick="unapproveIdea('${idea.id}')">Unapprove</button>` : ''}
                        ${idea.status !== 'rejected' ? `<button class="action-btn reject" onclick="rejectIdea('${idea.id}')">Reject</button>` : ''}
                        <select class="status-select" onchange="updateStatus('${idea.id}', this.value)">
                            <option value="pending" ${idea.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in-progress" ${idea.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="done" ${idea.status === 'done' ? 'selected' : ''}>Done</option>
                            <option value="rejected" ${idea.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                        <button class="action-btn delete" onclick="deleteIdea('${idea.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        async function approveIdea(id) {
            await getDatabase().ref(`ideas/${id}`).update({ approved: true, status: 'pending' });
        }

        async function unapproveIdea(id) {
            await getDatabase().ref(`ideas/${id}`).update({ approved: false });
        }

        async function rejectIdea(id) {
            await getDatabase().ref(`ideas/${id}`).update({ approved: false, status: 'rejected' });
        }

        async function updateStatus(id, status) {
            await getDatabase().ref(`ideas/${id}`).update({ status: status });
        }

        async function deleteIdea(id) {
            if (confirm('Are you sure you want to delete this idea?')) {
                await getDatabase().ref(`ideas/${id}`).remove();
            }
        }

        function openEditModal(id) {
            const idea = allIdeas.find(i => i.id === id);
            if (!idea) return;

            document.getElementById('editIdeaId').value = id;
            document.getElementById('editTitle').value = idea.title || '';
            document.getElementById('editDescription').value = idea.description || '';
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function saveEdit() {
            const id = document.getElementById('editIdeaId').value;
            const title = document.getElementById('editTitle').value.trim();
            const description = document.getElementById('editDescription').value.trim();

            if (!title || !description) {
                alert('Please fill in both title and description');
                return;
            }

            try {
                await getDatabase().ref(`ideas/${id}`).update({
                    title: title,
                    description: description
                });
                closeEditModal();
            } catch (error) {
                console.error('Error updating idea:', error);
                alert('Error saving changes. Please try again.');
            }
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        function initFilters() {
            document.querySelectorAll('.admin-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.admin-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderIdeas();
                });
            });
        }

        // Tab Navigation
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;

                    // Update button states
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Update tab content visibility
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.getElementById(tabName + 'Tab').classList.add('active');
                });
            });
        }

        // Push Notifications
        function initPushNotifications() {
            loadPushTokens();
            loadPushHistory();
            initPushForm();
        }

        function loadPushTokens() {
            if (!isFirebaseReady()) {
                setTimeout(loadPushTokens, 100);
                return;
            }

            getDatabase().ref('pushTokens').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    pushTokens = Object.keys(data)
                        .map(key => ({ id: key, ...data[key] }))
                        .filter(t => t.subscribed !== false);
                } else {
                    pushTokens = [];
                }
                document.getElementById('subscriberCount').textContent = pushTokens.length;
            });
        }

        function loadPushHistory() {
            if (!isFirebaseReady()) {
                setTimeout(loadPushHistory, 100);
                return;
            }

            getDatabase().ref('pushNotifications').orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    pushHistory = Object.keys(data)
                        .map(key => ({ id: key, ...data[key] }))
                        .sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    pushHistory = [];
                }
                renderPushHistory();
                updateTotalSent();
            });
        }

        function updateTotalSent() {
            getDatabase().ref('pushNotifications').once('value', (snapshot) => {
                const count = snapshot.numChildren() || 0;
                document.getElementById('totalSentCount').textContent = count;
            });
        }

        function renderPushHistory() {
            const container = document.getElementById('pushHistoryList');

            if (pushHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center;">No notifications sent yet.</p>';
                return;
            }

            container.innerHTML = pushHistory.map(notification => `
                <div class="push-history-item">
                    <div class="title">${escapeHtml(notification.title)}</div>
                    <div class="body">${escapeHtml(notification.body)}</div>
                    <div class="meta">
                        <span>Sent: ${formatDate(notification.timestamp)}</span>
                        <span>Recipients: ${notification.recipientCount || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        function initPushForm() {
            // Character counters
            const titleInput = document.getElementById('pushTitle');
            const bodyInput = document.getElementById('pushBody');
            const titleCount = document.getElementById('titleCount');
            const bodyCount = document.getElementById('bodyCount');

            titleInput.addEventListener('input', () => {
                titleCount.textContent = titleInput.value.length;
            });

            bodyInput.addEventListener('input', () => {
                bodyCount.textContent = bodyInput.value.length;
            });

            // Form submission
            document.getElementById('pushForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await sendPushNotification();
            });
        }

        async function sendPushNotification() {
            const title = document.getElementById('pushTitle').value.trim();
            const body = document.getElementById('pushBody').value.trim();
            const url = document.getElementById('pushUrl').value.trim();
            const icon = document.getElementById('pushIcon').value.trim();

            if (!title || !body) {
                alert('Please fill in both title and message body');
                return;
            }

            const sendBtn = document.getElementById('sendPushBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'Sending...';

            try {
                // Get all active push tokens
                const activeTokens = pushTokens.filter(t => t.subscribed !== false);

                if (activeTokens.length === 0) {
                    alert('No subscribers to send notifications to.');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        Send Notification
                    `;
                    return;
                }

                // Create notification record
                const notificationData = {
                    title: title,
                    body: body,
                    url: url || 'https://yourbibletracker.com',
                    icon: icon || '/logo.png',
                    timestamp: Date.now(),
                    recipientCount: activeTokens.length,
                    tokens: activeTokens.map(t => t.token)
                };

                // Save to Firebase (this will be picked up by a Cloud Function to send)
                const newNotificationRef = await getDatabase().ref('pushNotifications').push(notificationData);

                // Also save to pending queue for processing
                await getDatabase().ref('pushQueue').push({
                    notificationId: newNotificationRef.key,
                    ...notificationData,
                    status: 'pending'
                });

                // Clear form
                document.getElementById('pushTitle').value = '';
                document.getElementById('pushBody').value = '';
                document.getElementById('pushUrl').value = '';
                document.getElementById('titleCount').textContent = '0';
                document.getElementById('bodyCount').textContent = '0';

                alert(`Notification queued for ${activeTokens.length} subscriber(s)!\n\nNote: You'll need to set up a Firebase Cloud Function to actually send the notifications to devices. The notification data has been saved to the database.`);

            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Error sending notification. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Send Notification
                `;
            }
        }
    </script>
</body>
</html>
