<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - YourBibleTracker</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .admin-header h1 {
            color: var(--text-dark);
        }
        .logout-btn {
            background: var(--border);
            color: var(--text-dark);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .login-container {
            max-width: 400px;
            margin: 4rem auto;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
        }
        .login-container h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-card .label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        .admin-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .admin-idea-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .admin-idea-card.pending {
            border-left: 4px solid #F59E0B;
        }
        .admin-idea-card.approved {
            border-left: 4px solid #10B981;
        }
        .admin-idea-card.rejected {
            border-left: 4px solid #EF4444;
        }
        .idea-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .idea-title {
            font-size: 1.2rem;
            color: var(--text-dark);
            margin: 0;
        }
        .idea-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }
        .idea-meta span {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .idea-description {
            color: var(--text-light);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .idea-contact {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-white);
            border-radius: 0.5rem;
        }
        .idea-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .action-btn.approve {
            background: #10B981;
            color: white;
        }
        .action-btn.reject {
            background: #EF4444;
            color: white;
        }
        .action-btn.delete {
            background: var(--border);
            color: var(--text-dark);
        }
        .status-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.85rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.pending { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .status-badge.approved { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .status-badge.in-progress { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .status-badge.done { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .votes-badge {
            background: var(--bg-white);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            color: var(--text-dark);
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2>Admin Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="submit-btn">Login</button>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <nav>
            <div class="container nav-container">
                <a href="index.html" class="logo">
                    <img src="logo.png" alt="YourBibleTracker Logo" class="logo-image">
                    <span class="logo-text">Admin Panel</span>
                </a>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="admin-container">
            <div class="admin-header">
                <h1>Feature Request Management</h1>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="number" id="totalCount">0</div>
                    <div class="label">Total Ideas</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="pendingCount">0</div>
                    <div class="label">Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="approvedCount">0</div>
                    <div class="label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalVotes">0</div>
                    <div class="label">Total Votes</div>
                </div>
            </div>

            <div class="admin-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="pending">Pending</button>
                <button class="filter-btn" data-filter="approved">Approved</button>
                <button class="filter-btn" data-filter="rejected">Rejected</button>
            </div>

            <div id="adminIdeasList"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Password stored as SHA-256 hash - not in plain text
        const PASSWORD_HASH = '06face0984cb5b6e55a13b5e2a8f91cfdfccbdc73ea2ff14e7b1309ceccd1ccd';

        let allIdeas = [];
        let currentFilter = 'all';

        // SHA-256 hash function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if already logged in
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showAdminPanel();
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const hash = await sha256(password);
            if (hash === PASSWORD_HASH) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                alert('Incorrect password');
            }
        });

        function showAdminPanel() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            initFirebase();
            loadIdeas();
            initFilters();
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        function loadIdeas() {
            if (!isFirebaseReady()) {
                setTimeout(loadIdeas, 100);
                return;
            }

            getDatabase().ref('ideas').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    allIdeas = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    allIdeas.sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    allIdeas = [];
                }
                updateStats();
                renderIdeas();
            });
        }

        function updateStats() {
            const pending = allIdeas.filter(i => !i.approved && i.status !== 'rejected').length;
            const approved = allIdeas.filter(i => i.approved).length;
            const totalVotes = allIdeas.reduce((sum, i) => sum + (i.votes || 0), 0);

            document.getElementById('totalCount').textContent = allIdeas.length;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('totalVotes').textContent = totalVotes;
        }

        function filterIdeas() {
            if (currentFilter === 'all') return allIdeas;
            if (currentFilter === 'pending') return allIdeas.filter(i => !i.approved && i.status !== 'rejected');
            if (currentFilter === 'approved') return allIdeas.filter(i => i.approved);
            if (currentFilter === 'rejected') return allIdeas.filter(i => i.status === 'rejected');
            return allIdeas;
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function getStatusClass(idea) {
            if (idea.status === 'rejected') return 'rejected';
            if (idea.approved) return 'approved';
            return 'pending';
        }

        function renderIdeas() {
            const container = document.getElementById('adminIdeasList');
            const filtered = filterIdeas();

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No ideas found.</p>';
                return;
            }

            container.innerHTML = filtered.map(idea => `
                <div class="admin-idea-card ${getStatusClass(idea)}">
                    <div class="idea-header">
                        <h3 class="idea-title">${escapeHtml(idea.title)}</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="votes-badge">${idea.votes || 0} votes</span>
                            <span class="status-badge ${idea.status || 'pending'}">${idea.status || 'pending'}</span>
                        </div>
                    </div>
                    <div class="idea-meta">
                        <span><strong>Category:</strong> ${idea.category}</span>
                        <span><strong>Priority:</strong> ${idea.priority}</span>
                        <span><strong>Submitted:</strong> ${formatDate(idea.timestamp)}</span>
                    </div>
                    <p class="idea-description">${escapeHtml(idea.description)}</p>
                    <div class="idea-contact">
                        <strong>From:</strong> ${escapeHtml(idea.name)}
                        ${idea.email ? `| <strong>Email:</strong> ${escapeHtml(idea.email)}` : ''}
                    </div>
                    <div class="idea-actions">
                        ${!idea.approved ? `<button class="action-btn approve" onclick="approveIdea('${idea.id}')">Approve</button>` : ''}
                        ${idea.approved ? `<button class="action-btn reject" onclick="unapproveIdea('${idea.id}')">Unapprove</button>` : ''}
                        ${idea.status !== 'rejected' ? `<button class="action-btn reject" onclick="rejectIdea('${idea.id}')">Reject</button>` : ''}
                        <select class="status-select" onchange="updateStatus('${idea.id}', this.value)">
                            <option value="pending" ${idea.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in-progress" ${idea.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="done" ${idea.status === 'done' ? 'selected' : ''}>Done</option>
                            <option value="rejected" ${idea.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                        <button class="action-btn delete" onclick="deleteIdea('${idea.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        async function approveIdea(id) {
            await getDatabase().ref(`ideas/${id}`).update({ approved: true, status: 'pending' });
        }

        async function unapproveIdea(id) {
            await getDatabase().ref(`ideas/${id}`).update({ approved: false });
        }

        async function rejectIdea(id) {
            await getDatabase().ref(`ideas/${id}`).update({ approved: false, status: 'rejected' });
        }

        async function updateStatus(id, status) {
            await getDatabase().ref(`ideas/${id}`).update({ status: status });
        }

        async function deleteIdea(id) {
            if (confirm('Are you sure you want to delete this idea?')) {
                await getDatabase().ref(`ideas/${id}`).remove();
            }
        }

        function initFilters() {
            document.querySelectorAll('.admin-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.admin-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderIdeas();
                });
            });
        }
    </script>
</body>
</html>
